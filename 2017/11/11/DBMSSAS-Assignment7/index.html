<!DOCTYPE html><html lang=""><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> DBMSSAS Assignment7 · Mingo的博客</title><meta name="description" content="Welcome to my personal blog"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">Home</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   Blog</a></li><li class="nav-list-item"><a href="https://github.com/mingotang" target="_blank" class="nav-link">github</a></li><li class="nav-list-item"><a href="http://www.jianshu.com/users/12bf64a47246" target="_blank" class="nav-link">jianshu</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2017/11/11/DBMSSAS-Assignment7/" class="post-title-link">DBMSSAS Assignment7</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/TA/" class="post-tag-link">TA</a></li></ul><div class="post-time">Saturday, November 11th 2017</div></div><div class="post-content"><a id="more"></a>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><ol>
<li>Write a trigger to implement the function: store ‘M’ for ‘男’ and ‘F’ for ‘女’ as ssex value of a new tuple inserted into Student.</li>
<li>Create the function float sf_getAverageGrade(@sname nchar(10)). The function returns -1 if there is no student called @sname; returns -2 if there are more than one student called @sname; returns the average grade of student sname if he/she has at least one course grade; returns null if student @sname has no course grade. Show the function result when the parameter @sname equals ‘李少西’.</li>
<li>Create the stored procedure sp_displayGrades(@sname nchar(10)). The Stored procedure displays the student name and his/her total number of selected courses, minimum grade, average grade and maximum grade. Show the stored procedure result when the parameter @sname equals ‘李少西’.</li>
</ol>
<hr>
<h2 id="Answer"><a href="#Answer" class="headerlink" title="Answer"></a>Answer</h2><p>(1) Write a trigger to implement the function: store ‘M’ for ‘男’ and ‘F’ for ‘女’ as ssex value of a new tuple inserted into Student.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> ssexTrig</div><div class="line"><span class="keyword">ON</span> studentb <span class="keyword">AFTER</span> <span class="keyword">INSERT</span></div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	<span class="keyword">UPDATE</span> studentb</div><div class="line">		<span class="keyword">SET</span> ssex=<span class="string">'M'</span></div><div class="line">		<span class="keyword">WHERE</span> ssex=<span class="string">'男'</span> <span class="keyword">and</span> sno=(<span class="keyword">SELECT</span> sno <span class="keyword">FROM</span> inserted);</div><div class="line">	<span class="keyword">UPDATE</span> studentb</div><div class="line">		<span class="keyword">SET</span> ssex=<span class="string">'F'</span></div><div class="line">		<span class="keyword">WHERE</span> ssex=<span class="string">'女'</span> <span class="keyword">and</span> sno=(<span class="keyword">SELECT</span> sno <span class="keyword">FROM</span> inserted);</div><div class="line"><span class="keyword">END</span></div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> ssexTrig</div><div class="line"><span class="keyword">ON</span> studentb <span class="keyword">AFTER</span> <span class="keyword">INSERT</span></div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	<span class="keyword">DECLARE</span> @ssex <span class="keyword">nchar</span>(<span class="number">2</span>);</div><div class="line">	<span class="keyword">DECLARE</span> @sno <span class="keyword">nchar</span>(<span class="number">10</span>);</div><div class="line">	<span class="keyword">SET</span> @sno=(<span class="keyword">SELECT</span> sno <span class="keyword">FROM</span> inserted);</div><div class="line">	<span class="keyword">SET</span> @ssex=(<span class="keyword">SELECT</span> ssex <span class="keyword">FROM</span> inserted);</div><div class="line"></div><div class="line">	IF @ssex='男'</div><div class="line">		<span class="keyword">SET</span> @ssex=<span class="string">'M'</span></div><div class="line">	<span class="keyword">ELSE</span> <span class="keyword">IF</span> @ssex=<span class="string">'女'</span></div><div class="line">		<span class="keyword">SET</span> @ssex=<span class="string">'F'</span></div><div class="line"></div><div class="line">	<span class="keyword">UPDATE</span> studentb</div><div class="line">		<span class="keyword">SET</span> ssex=@ssex</div><div class="line">		<span class="keyword">WHERE</span> sno=@sno;</div><div class="line"><span class="keyword">END</span></div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> ssexTrig</div><div class="line"><span class="keyword">ON</span> studentb INSTEAD <span class="keyword">OF</span> <span class="keyword">INSERT</span></div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> studentb(sno,sname,sage,sdept,ssex)</div><div class="line">	<span class="keyword">SELECT</span> sno,sname,sage,sdept,</div><div class="line">		<span class="keyword">CASE</span></div><div class="line">			<span class="keyword">WHEN</span> ssex=<span class="string">'男'</span> <span class="keyword">THEN</span> <span class="string">'M'</span></div><div class="line">			<span class="keyword">WHEN</span> ssex=<span class="string">'女'</span> <span class="keyword">THEN</span> <span class="string">'F'</span></div><div class="line">		<span class="keyword">END</span> <span class="keyword">AS</span> ssex</div><div class="line">	<span class="keyword">FROM</span> inserted</div></pre></td></tr></table></figure>
<p>(2) Create the function float sf_getAverageGrade(@sname nchar(10)). The function returns -1 if there is no student called @sname; returns -2 if there are more than one student called @sname; returns the average grade of student sname if he/she has at least one course grade; returns null if student @sname has no course grade. Show the function result when the parameter @sname equals ‘李少西’.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> sf_getAverageGrade(@sname <span class="keyword">nchar</span>(<span class="number">10</span>))</div><div class="line"><span class="keyword">RETURNS</span> <span class="built_in">REAL</span></div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	<span class="keyword">DECLARE</span> @<span class="keyword">count</span> <span class="built_in">INT</span>;</div><div class="line">	<span class="keyword">SET</span> @<span class="keyword">count</span>=(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> sname=@sname);</div><div class="line">	IF @count=0</div><div class="line">		RETURN -1;</div><div class="line">	ELSE IF(@count&gt;1)</div><div class="line">		RETURN -2;</div><div class="line">	ELSE</div><div class="line">		RETURN (<span class="keyword">SELECT</span> <span class="keyword">ROUND</span>(<span class="keyword">AVG</span>(grade),<span class="number">2</span>) <span class="keyword">FROM</span> student s,SC <span class="keyword">WHERE</span> sname=@sname <span class="keyword">and</span> s.sno=SC.sno);</div><div class="line">	RETURN NULL;</div><div class="line"><span class="keyword">END</span></div></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Select dbo.sf_getAverageGrade(&apos;李少西&apos;);</div></pre></td></tr></table></figure>
<p>可以得到结果</p>
<p><img src="http://ox3grgjnx.bkt.clouddn.com/DBMSSAS_Assignment_7-002.png" alt="running result"></p>
<p>(3) Create the stored procedure sp_displayGrades(@sname nchar(10)). The Stored procedure displays the student name and his/her total number of selected courses, minimum grade, average grade and maximum grade. Show the stored procedure result when the parameter @sname equals ‘李少西’.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> sp_displayGradeRow(@sname <span class="keyword">nchar</span>(<span class="number">10</span>))</div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	<span class="keyword">DECLARE</span> @cname <span class="keyword">nchar</span>(<span class="number">20</span>);</div><div class="line">	<span class="keyword">DECLARE</span> @grade <span class="built_in">float</span>;</div><div class="line">	<span class="keyword">DECLARE</span> @titlestr <span class="keyword">nvarchar</span>(<span class="number">200</span>);</div><div class="line">	<span class="keyword">DECLARE</span> @gradestr <span class="keyword">nvarchar</span>(<span class="number">200</span>);</div><div class="line">	<span class="keyword">DECLARE</span> @<span class="keyword">str</span> <span class="keyword">nvarchar</span>(<span class="number">10</span>);</div><div class="line">	<span class="keyword">SET</span> @titlestr=<span class="string">'姓名'</span>+<span class="built_in">char</span>(<span class="number">9</span>);</div><div class="line">	<span class="keyword">SET</span> @gradestr=<span class="keyword">rtrim</span>(@sname)+<span class="built_in">char</span>(<span class="number">9</span>);</div><div class="line"></div><div class="line">	<span class="keyword">DECLARE</span> gcursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></div><div class="line">	(<span class="keyword">SELECT</span> cname,grade <span class="keyword">FROM</span> SC,course C, student S</div><div class="line">		<span class="keyword">WHERE</span> SC.cno=C.cno <span class="keyword">and</span> sname=@sname <span class="keyword">and</span> SC.sno=S.sno);</div><div class="line"></div><div class="line">	OPEN gcursor;</div><div class="line">	FETCH NEXT FROM gcursor into @cname,@grade;</div><div class="line">	WHILE @@FETCH_STATUS=0</div><div class="line">	<span class="keyword">BEGIN</span></div><div class="line">		<span class="keyword">SET</span> @titlestr=@titlestr+<span class="keyword">substring</span>(@cname,<span class="number">1</span>,<span class="number">7</span>);</div><div class="line">		<span class="keyword">SET</span> @gradestr=@gradestr+<span class="keyword">cast</span>(@grade <span class="keyword">AS</span> <span class="keyword">nchar</span>(<span class="number">10</span>));</div><div class="line">		FETCH NEXT FROM gcursor into @cname,@grade;</div><div class="line">	<span class="keyword">END</span></div><div class="line">	<span class="keyword">SET</span> @titlestr=@titlestr+<span class="string">'平均成绩'</span>;</div><div class="line">	<span class="keyword">SET</span> @gradestr=@gradestr+<span class="keyword">cast</span>(dbo.sf_getAverageGrade(@sname) <span class="keyword">AS</span> <span class="keyword">nchar</span>(<span class="number">5</span>));</div><div class="line">	PRINT @titlestr;</div><div class="line">	PRINT @gradestr;</div><div class="line">	CLOSE gcursor;</div><div class="line">	<span class="keyword">DEALLOCATE</span> gcursor;</div><div class="line"></div><div class="line"><span class="keyword">END</span></div></pre></td></tr></table></figure>
<p>运行得到结果</p>
<p><img src="http://ox3grgjnx.bkt.clouddn.com/DBMSSAS_Assignment_7-003.png" alt="running result"></p>
<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ul>
<li>第一问当中条件约束缺少，会导致数据库运行很多不必要内容甚至卡死，例如以下例子，这个trigger会在每一次插入之后扫描整个数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> ssexTrig</div><div class="line"><span class="keyword">ON</span> studentb <span class="keyword">AFTER</span> <span class="keyword">INSERT</span></div><div class="line"><span class="keyword">AS</span></div><div class="line"><span class="keyword">BEGIN</span></div><div class="line">	<span class="keyword">UPDATE</span> studentb</div><div class="line">		<span class="keyword">SET</span> ssex=<span class="string">'M'</span></div><div class="line">		<span class="keyword">WHERE</span> ssex=<span class="string">'男'</span>;</div><div class="line">	<span class="keyword">UPDATE</span> studentb</div><div class="line">		<span class="keyword">SET</span> ssex=<span class="string">'F'</span></div><div class="line">		<span class="keyword">WHERE</span> ssex=<span class="string">'女'</span>;</div><div class="line"><span class="keyword">END</span></div></pre></td></tr></table></figure>
<ul>
<li>第一问当中触发器条件是after insert， 这时候应当修改数据表而不是历史记录inserted或者自己定义的内存中的变量ssex</li>
</ul>
</div></article><div class="pagination"><span class="pagination-prev">PREV</span><a href="/2017/11/03/DBMSSAS-Assignment6/" class="pagination-next">NEXT</a></div><div class="comments"></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/">Blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/COLLECTION/">COLLECTION</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Notes/">Notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TA/">TA</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/DBMSSAS-Assignment7/">DBMSSAS Assignment7</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/03/DBMSSAS-Assignment6/">DBMSSAS Assignment6</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/21/DBMSSAS-Assignment5/">DBMSSAS Assignment5</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/13/DBMSSAS-Assignment4/">DBMSSAS Assignment4</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/10/Sharing/">Sharing</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/29/DBMSSAS-Assignment3/">DBMSSAS Assignment3</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/28/Python-资源包大全/">Python 资源包大全</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/26/DBMSSAS-Assignment2/">DBMSSAS Assignment2</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2017 <a href="/">Mingo Tang</P></div><div class="power"><p><a href="http://pinggod.com/">Sean Sun</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://jekyllrb.com/">Jekyll</a></p></div></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>